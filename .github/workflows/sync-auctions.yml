name: Sync Auctions

on:
  schedule:
    # Run every 12 hours to reduce database load
    - cron: '0 */12 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

# Prevent overlapping runs from saturating the database
concurrency:
  group: sync-auctions
  cancel-in-progress: false

jobs:
  # Job 1: Trigger edge function for smaller inventory types
  trigger-small-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger small inventory sync via edge function
        run: |
          echo "Triggering small inventory sync..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://orbygspxutudncbyipst.supabase.co/functions/v1/cron-sync-auctions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yYnlnc3B4dXR1ZG5jYnlpcHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2NjQsImV4cCI6MjA4Mzk5NzY2NH0.956zo-yz_1rikHRWfppReftYeDmQf0xy60gezsbONec" \
            --max-time 300 || true)
          
          echo "Response: $response"
          echo "âœ… Small inventory sync triggered"

  # Job 2: Run Node.js script for large GoDaddy inventory files
  # This bypasses edge function timeout/memory limits
  # Timeout set to 3 hours (should complete in ~1-2 hours with optimized batching)
  sync-large-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    needs: trigger-small-sync
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install adm-zip

      - name: Run large inventory sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SYNC_SECRET: ${{ secrets.SYNC_SECRET }}
        run: node .github/scripts/sync-large-inventory.cjs

      - name: Log completion
        run: echo "GoDaddy auction sync completed at $(date)"

  # Job 3: Sync Namecheap inventory via Playwright browser automation
  # Downloads the ~170MB CSV export and syncs ~916k records
  # Timeout set to 4 hours to allow for large file download and processing
  sync-namecheap-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: sync-large-inventory
    env:
      # Install browsers into node_modules so Playwright can always find them
      PLAYWRIGHT_BROWSERS_PATH: '0'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm install playwright
          # Install Chromium plus the dedicated headless-shell binary Playwright may prefer in CI.
          # The headless shell is installed via `--only-shell` (it is NOT a separate browser name).
          PLAYWRIGHT_BROWSERS_PATH=0 npx playwright --version
          PLAYWRIGHT_BROWSERS_PATH=0 npx playwright install --with-deps chromium
          PLAYWRIGHT_BROWSERS_PATH=0 npx playwright install --with-deps chromium --only-shell

      - name: Verify Playwright browser install
        run: |
          node -e "const { chromium } = require('playwright'); console.log('Chromium executablePath:', chromium.executablePath());"
          ls -la node_modules/playwright-core/.local-browsers 2>/dev/null || true
          ls -la node_modules/playwright/.local-browsers 2>/dev/null || true

      - name: Run Namecheap inventory sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SYNC_SECRET: ${{ secrets.SYNC_SECRET }}
          PLAYWRIGHT_BROWSERS_PATH: '0'
        run: node .github/scripts/sync-namecheap-inventory.cjs

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: namecheap-debug-screenshots
          path: .temp-inventory/*.png
          retention-days: 7

      - name: Log completion
        run: echo "Namecheap auction sync completed at $(date)"

  # Final summary job
  sync-summary:
    runs-on: ubuntu-latest
    needs: [trigger-small-sync, sync-large-inventory, sync-namecheap-inventory]
    if: always()
    steps:
      - name: Sync Summary
        run: |
          echo "=========================================="
          echo "Full Auction Sync Completed"
          echo "=========================================="
          echo "Time: $(date)"
          echo "Small sync status: ${{ needs.trigger-small-sync.result }}"
          echo "GoDaddy sync status: ${{ needs.sync-large-inventory.result }}"
          echo "Namecheap sync status: ${{ needs.sync-namecheap-inventory.result }}"
          echo "=========================================="
