name: Sync Auctions

on:
  schedule:
    # Run every 12 hours to reduce database load
    - cron: '0 */12 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

# Prevent overlapping runs from saturating the database
concurrency:
  group: sync-auctions
  cancel-in-progress: false

jobs:
  # Job 1: Trigger edge function for smaller inventory types
  trigger-small-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger small inventory sync via edge function
        run: |
          echo "Triggering small inventory sync..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "https://orbygspxutudncbyipst.supabase.co/functions/v1/cron-sync-auctions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yYnlnc3B4dXR1ZG5jYnlpcHN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2NjQsImV4cCI6MjA4Mzk5NzY2NH0.956zo-yz_1rikHRWfppReftYeDmQf0xy60gezsbONec" \
            --max-time 300 || true)
          
          echo "Response: $response"
          echo "âœ… Small inventory sync triggered"

  # Job 2: Run Node.js script for large GoDaddy inventory files
  # This bypasses edge function timeout/memory limits
  # Timeout set to 6 hours to handle 780k+ records with network variability
  sync-large-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    needs: trigger-small-sync
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install adm-zip

      - name: Run large inventory sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SYNC_SECRET: ${{ secrets.SYNC_SECRET }}
        run: node .github/scripts/sync-large-inventory.cjs

      - name: Log completion
        run: echo "GoDaddy auction sync completed at $(date)"

  # Job 3: Sync Namecheap inventory via Playwright browser automation
  # Downloads the ~170MB CSV export and syncs ~916k records
  # Timeout set to 4 hours to allow for large file download and processing
  sync-namecheap-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: sync-large-inventory
    env:
      # Use a single explicit browsers path so the Playwright CLI install and runtime
      # always agree on where Chromium + chromium-headless-shell live.
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.pw-browsers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright (pinned) + browsers
        run: |
          # Ensure we don't reuse stale/partial downloads
          rm -rf "$PLAYWRIGHT_BROWSERS_PATH" || true

          # Pin Playwright to keep browser revision stable across runs
          npm install playwright@1.57.0

          node -e "console.log('playwright pkg version =', require('playwright/package.json').version)"
          npx playwright --version

          # Install full Chromium + the required headless shell (force to avoid partial installs)
          npx playwright install --force --with-deps chromium chromium-headless-shell

      - name: Preflight browser launch
        # Fail fast if the browser binaries are still missing
        run: |
          echo "PLAYWRIGHT_BROWSERS_PATH=$PLAYWRIGHT_BROWSERS_PATH"
          ls -la "$PLAYWRIGHT_BROWSERS_PATH" || true
          node -e "
            const { chromium } = require('playwright');
            const fs = require('fs');
            (async () => {
              console.log('Preflight: playwright pkg version =', require('playwright/package.json').version);
              console.log('Preflight: chromium.executablePath() =', chromium.executablePath());
              if (!fs.existsSync(chromium.executablePath())) {
                throw new Error('Preflight: Chromium executable missing at expected path. Browser download likely incomplete.');
              }
              console.log('Preflight: launching Chromium headless...');
              const browser = await chromium.launch({ headless: true });
              console.log('Preflight: browser version =', await browser.version());
              await browser.close();
              console.log('Preflight: OK');
            })();
          "

      - name: Run Namecheap inventory sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SYNC_SECRET: ${{ secrets.SYNC_SECRET }}
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.pw-browsers
        run: node .github/scripts/sync-namecheap-inventory.cjs

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: namecheap-debug-screenshots
          path: .temp-inventory/*.png
          retention-days: 7

      - name: Log completion
        run: echo "Namecheap auction sync completed at $(date)"

  # Final summary job
  sync-summary:
    runs-on: ubuntu-latest
    needs: [trigger-small-sync, sync-large-inventory, sync-namecheap-inventory]
    if: always()
    steps:
      - name: Sync Summary
        run: |
          echo "=========================================="
          echo "Full Auction Sync Completed"
          echo "=========================================="
          echo "Time: $(date)"
          echo "Small sync status: ${{ needs.trigger-small-sync.result }}"
          echo "GoDaddy sync status: ${{ needs.sync-large-inventory.result }}"
          echo "Namecheap sync status: ${{ needs.sync-namecheap-inventory.result }}"
          echo "=========================================="
